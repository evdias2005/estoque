{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}{{ acao }} Cliente{% endblock %}
{% block page_title %}{{ acao }} Cliente{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-body">
            <form method="post" novalidate>
                {% csrf_token %}

                {# Mensagens de erro gerais #}
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}

                {# Campos do Cliente #}
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">{{ form.codigo.label }}</label>
                        {{ form.codigo|add_class:"form-control" }}
                        {% for error in form.codigo.errors %}
                            <small class="text-danger">{{ error }}</small>
                        {% endfor %}
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">{{ form.nome.label }}</label>
                        {{ form.nome|add_class:"form-control" }}
                        {% for error in form.nome.errors %}
                            <small class="text-danger">{{ error }}</small>
                        {% endfor %}
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">{{ form.endereco.label }}</label>
                    {{ form.endereco|add_class:"form-control" }}
                    {% for error in form.endereco.errors %}
                        <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                </div>

                <hr>

                {# Formset de Contatos #}
                <h5 class="mb-3">Contatos</h5>
                {{ formset.management_form }}
                <div id="contatos">
                    {% for subform in formset %}
                        <div class="row mb-2 contato-form">
                            <div class="col-md-5">
                                <label class="form-label">{{ subform.nome.label }}</label>
                                {{ subform.nome|add_class:"form-control" }}
                                {% for error in subform.nome.errors %}
                                    <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">{{ subform.telefone.label }}</label>
                                {{ subform.telefone|add_class:"form-control" }}
                                {% for error in subform.telefone.errors %}
                                    <small class="text-danger">{{ error }}</small>
                                {% endfor %}
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                {% if subform.DELETE %}
                                    <div class="form-check">
                                        {{ subform.DELETE }}
                                        <label class="form-check-label">Excluir</label>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <button type="button" class="btn btn-outline-primary mb-3" id="add-contato">
                    + Adicionar Contato
                </button>

                <hr>

                {# Botões de ação #}
                <button type="submit" class="btn btn-success">
                    <span class="material-icons align-middle">save</span> Salvar
                </button>
                <a href="{% url 'cliente_list' %}" class="btn btn-secondary">
                    <span class="material-icons align-middle">cancel</span> Cancelar
                </a>
            </form>
        </div>
    </div>
</div>

<script>
document.getElementById('add-contato').addEventListener('click', function() {
    let totalForms = document.getElementById('id_form-TOTAL_FORMS');
    let formCount = parseInt(totalForms.value);
    let contatosDiv = document.getElementById('contatos');

    // Clona o primeiro formulário de contato
    let newForm = contatosDiv.querySelector('.contato-form').cloneNode(true);

    // Limpa valores e ajusta name/id de cada input
    newForm.querySelectorAll('input').forEach(input => {
        let name = input.name.replace(/\d+/, formCount);
        let id = 'id_' + name;
        input.name = name;
        input.id = id;
        input.value = '';
        if (input.type === 'checkbox') input.checked = false;
    });

    contatosDiv.appendChild(newForm);
    totalForms.value = formCount + 1;
});
</script>
{% endblock %}
